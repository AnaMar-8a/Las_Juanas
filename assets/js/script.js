/**
 * PROYECTO: Abecedario Político Interactivo - Escuela Las Juanas
 * VERSIÓN:  4.1 (Multilingüe + Memoria)
 * FECHA:    Octubre 2025
 */

// ========================================================================
// --- 0. DICCIONARIO DE INTERFAZ (UI) ---
// Textos fijos de la página que cambian según el idioma.
// ========================================================================
const uiTranslations = {
    es: {
        welcome_tag: "Este Glosario hace parte de las herramientas generadas por la <strong>Escuela de Formación Política Feminista Las Juanas</strong>",
        title_main: "Abecedario Político",
        subtitle: "Palabras que nutren nuestro mundo",
        quote: "\"Nombrar es el primer paso para transformar.\"",
        intro: "Este glosario es una herramienta viva, una invitación a apropiarnos de los conceptos que nos permiten analizar nuestra realidad con una mirada crítica.",
        search_placeholder: "Buscar un término...",
        btn_random: "Aleatorio",
        creators_title: "Co-creación de la escuela:",
        footer_text: "Diseño por",
        no_results: "No se encontraron términos.",
        example_label: "Ejemplo cotidiano:",
        error_load: "Error al cargar el glosario."
    },
    en: {
        welcome_tag: "This Glossary is part of the tools generated by the <strong>Las Juanas Feminist Political Training School</strong>",
        title_main: "Political Alphabet",
        subtitle: "Words that nourish our world",
        quote: "\"Naming is the first step to transforming.\"",
        intro: "This glossary is a living tool, an invitation to appropriate the concepts that allow us to analyze our reality with a critical gaze.",
        search_placeholder: "Search for a term...",
        btn_random: "Random",
        creators_title: "Co-created by the school:",
        footer_text: "Designed by",
        no_results: "No terms found.",
        example_label: "Everyday example:",
        error_load: "Error loading glossary."
    },
    pt: {
        welcome_tag: "Este Glossário faz parte das ferramentas geradas pela <strong>Escola de Formação Política Feminista Las Juanas</strong>",
        title_main: "Abecedário Político",
        subtitle: "Palavras que nutrem nosso mundo",
        quote: "\"Nomear é o primeiro passo para transformar.\"",
        intro: "Este glossário é uma ferramenta viva, um convite para nos apropriarmos dos conceitos que nos permitem analisar nossa realidade com um olhar crítico.",
        search_placeholder: "Buscar um termo...",
        btn_random: "Aleatório",
        creators_title: "Co-criação da escola:",
        footer_text: "Design por",
        no_results: "Nenhum termo encontrado.",
        example_label: "Exemplo cotidiano:",
        error_load: "Erro ao carregar o glossário."
    }
};

// Intentamos recuperar el idioma guardado, si no existe, usamos español.
let currentLang = localStorage.getItem('abecedario_lang') || 'es';
let glossaryData = [];

// ========================================================================
// --- 1. BLOQUE DE INICIALIZACIÓN ---
// ========================================================================
document.addEventListener('DOMContentLoaded', function () {

    // Referencias DOM
    const alphabetNavDesktop = document.getElementById('alphabet-nav-desktop');
    const alphabetNavMobile = document.getElementById('mobile-nav-scroll');
    const mainContent = document.getElementById('main-content');
    const homeButtonDesktop = document.getElementById('home-button-desktop');
    const homeButtonMobile = document.getElementById('home-button-mobile');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');

    // Cargar datos del JSON
    fetch('glossary.json')
        .then(response => {
            if (!response.ok) throw new Error('Error de red');
            return response.json();
        })
        .then(data => {
            glossaryData = data.terms;
            initializeApp();
        })
        .catch(error => {
            console.error('Error:', error);
            mainContent.innerHTML = `<p class="text-center text-red-500 mt-10">Error loading data / Error cargando datos.</p>`;
        });

    // --- FUNCIÓN DE ARRANQUE ---
    function initializeApp() {
        actualizarBotonesIdioma(); // Marca el botón del idioma actual
        setupNav();                // Crea la lista de letras
        mostrarAbrazoInicial();    // Muestra la portada

        // Inicia la animación de fondo
        resizeCanvas();
        initRhizome();
        animate();

        // Eventos Globales
        homeButtonDesktop.addEventListener('click', handleHomeClick);
        homeButtonMobile.addEventListener('click', handleHomeClick);

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) cerrarEspacioDeReflexion();
        });

        window.addEventListener('resize', () => {
            resizeCanvas();
            initRhizome();
        });
    }

    // ========================================================================
    // --- 2. GESTIÓN DE IDIOMA ---
    // ========================================================================
    
    // Función global para ser llamada desde el HTML
    window.cambiarIdioma = function(lang) {
        if (glossaryData.length === 0) return; // Esperar a que carguen datos
        
        currentLang = lang;
        localStorage.setItem('abecedario_lang', lang); // Guardar preferencia

        actualizarBotonesIdioma();
        
        // Recargar la vista actual (volvemos al inicio para refrescar textos)
        mostrarAbrazoInicial(); 
        // Nota: Si estuviéramos en una letra específica, podríamos llamar a renderizarListaDeTerminos(letraActual) aquí.
    };

    function actualizarBotonesIdioma() {
        document.querySelectorAll('.lang-btn').forEach(btn => {
            if(btn.dataset.lang === currentLang) {
                // Estilo Activo
                btn.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                btn.classList.remove('hover:bg-purple-100', 'text-gray-700');
            } else {
                // Estilo Inactivo
                btn.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                btn.classList.add('hover:bg-purple-100', 'text-gray-700');
            }
        });
    }

    // ========================================================================
    // --- 3. RENDERIZADO DE VISTAS ---
    // ========================================================================

    function mostrarAbrazoInicial() {
        const t = uiTranslations[currentLang]; // Textos traducidos UI

        mainContent.innerHTML = `
            <div class="content-slide h-full flex flex-col justify-between items-center text-center relative">
                <div class="w-full bg-purple-100/50 text-purple-800 text-sm py-1 text-center absolute top-0 left-0">
                    ${t.welcome_tag}
                </div>

                <div class="flex-grow flex flex-col justify-center pt-10 px-4">
                    <h3 class="text-xl md:text-2xl text-purple-700 font-semibold font-title">${t.subtitle}</h3>
                    <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mt-4 tracking-tighter font-title">${t.title_main}</h1>
                    <p class="text-base md:text-lg text-gray-600 max-w-3xl mx-auto mt-6 italic">${t.quote}</p>
                    <p class="text-sm md:text-md text-gray-700 max-w-2xl mx-auto mt-2 hidden md:block">${t.intro}</p>
                    
                    <div class="mt-8 flex justify-center items-center gap-4 w-full">
                        <input id="search-input" type="text" placeholder="${t.search_placeholder}" class="w-full max-w-xs p-2 rounded-full border-2 border-stone-300 bg-white/50 focus:border-purple-400 focus:ring-0 outline-none transition-colors">
                        <button id="random-term-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105 whitespace-nowrap">
                            ${t.btn_random}
                        </button>
                    </div>
                </div>

                <div class="flex-shrink-0 w-full pt-4 mb-10 pb-2">
                    <h4 class="font-bold text-gray-700 mb-3 font-title text-sm">${t.creators_title}</h4>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 justify-center text-xs md:text-sm">
                        <a href="https://www.instagram.com/electas__/" target="_blank" class="creator-link">Movimiento Político Electas</a>
                        <a href="https://www.institutoupdate.org.br/es/" target="_blank" class="creator-link">Instituto Update</a>
                        <a href="https://www.instagram.com/ongrecuperandoidentidad/" target="_blank" class="creator-link">Recuperando Identidad</a>
                    </div>
                </div>

                <footer class="w-full bg-purple-700 text-white text-center p-2 absolute bottom-0 left-0 text-xs">
                    ${t.footer_text} <a href="https://www.linkedin.com/in/8aanamaria/" target="_blank" class="font-bold underline hover:text-purple-200">AnaMar8a</a>
                </footer>
            </div>
        `;

        // Reasignar eventos
        document.getElementById('random-term-btn').addEventListener('click', mostrarTerminoAleatorio);
        document.getElementById('search-input').addEventListener('input', manejarBusqueda);
    }

    function renderizarListaDeTerminos(letter) {
        // La letra es universal, filtramos por ella
        const terms = glossaryData.filter(item => item.letter === letter);
        
        const termButtons = terms.map(item => {
            // AQUÍ LA MAGIA: Leemos el contenido del idioma actual
            // Si falta traducción, usamos español como respaldo (fallback)
            const content = item.content[currentLang] || item.content['es'];
            
            return `<button class="term-link block w-full text-left text-xl md:text-3xl font-bold text-gray-700 p-3 md:p-4 rounded-xl hover:bg-white/60 transition-colors" data-id="${item.id}">
                ${content.term}
            </button>`
        }).join('');

        mainContent.innerHTML = `
            <div class="content-slide">
                <h2 class="text-6xl md:text-8xl font-extrabold text-purple-800/10 mb-8 select-none">${letter}</h2>
                <div class="space-y-2 md:space-y-3 pb-20">${termButtons}</div>
            </div>
        `;

        document.querySelectorAll('.term-link').forEach(button => {
            button.addEventListener('click', () => {
                abrirCuidadoDeLaPalabra(button.dataset.id);
            });
        });
    }

    // ========================================================================
    // --- 4. MODAL Y BÚSQUEDA ---
    // ========================================================================

    function abrirCuidadoDeLaPalabra(termId) {
        // Buscamos por ID (que es universal)
        const item = glossaryData.find(i => i.id === termId);
        if (!item) return;

        const content = item.content[currentLang] || item.content['es'];
        const ui = uiTranslations[currentLang];

        const contentHTML = `
            <button id="close-modal-inner" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold" aria-label="Cerrar">&times;</button>
            <h2 class="text-3xl md:text-4xl font-extrabold font-title text-gray-800 mb-6 pr-8">${content.term}</h2>
            <div class="prose prose-lg max-w-none text-gray-700">
                <p>${content.definition}</p>
                <div class="mt-6 p-4 rounded-xl bg-[#fbf9f6] border-l-4 border-purple-400">
                    <h4 class="font-bold text-gray-800 text-sm mb-1 uppercase tracking-wide">${ui.example_label}</h4>
                    <p class="italic text-gray-600">${content.practice}</p>
                </div>
            </div>
        `;
        modalContent.innerHTML = contentHTML;

        modalOverlay.classList.remove('opacity-0', 'pointer-events-none');
        modalContent.classList.remove('scale-95', 'opacity-0');

        document.getElementById('close-modal-inner').addEventListener('click', cerrarEspacioDeReflexion);
    }

    function cerrarEspacioDeReflexion() {
        modalOverlay.classList.add('opacity-0', 'pointer-events-none');
        modalContent.classList.add('scale-95', 'opacity-0');
    }

    function mostrarTerminoAleatorio() {
        const randomIndex = Math.floor(Math.random() * glossaryData.length);
        const randomTerm = glossaryData[randomIndex];
        abrirCuidadoDeLaPalabra(randomTerm.id);
    }

    function manejarBusqueda(event) {
        const searchTerm = event.target.value.toLowerCase();
        let resultsContainer = document.getElementById('search-results-container');
        
        if (!resultsContainer) {
            resultsContainer = document.createElement('div');
            resultsContainer.id = 'search-results-container';
            resultsContainer.className = 'absolute top-24 left-1/2 -translate-x-1/2 w-72 max-h-60 overflow-y-auto bg-white/95 backdrop-blur-sm shadow-xl rounded-xl p-2 z-20 border border-gray-100';
            mainContent.appendChild(resultsContainer);
        }

        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        // Búsqueda inteligente: Busca en el término DEL IDIOMA ACTUAL
        const filteredData = glossaryData.filter(item => {
            const content = item.content[currentLang] || item.content['es'];
            return content.term.toLowerCase().includes(searchTerm);
        });

        const ui = uiTranslations[currentLang];

        const termButtons = filteredData.map(item => {
            const content = item.content[currentLang] || item.content['es'];
            return `<button class="term-link block w-full text-left text-sm font-bold text-gray-700 p-2 rounded-lg hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-0" data-id="${item.id}">
                ${content.term}
            </button>`
        }).join('');

        resultsContainer.innerHTML = termButtons || `<p class="text-center text-xs text-stone-500 p-2">${ui.no_results}</p>`;

        document.querySelectorAll('#search-results-container .term-link').forEach(button => {
            button.addEventListener('click', () => {
                abrirCuidadoDeLaPalabra(button.dataset.id);
                resultsContainer.innerHTML = '';
                document.getElementById('search-input').value = '';
            });
        });
        
        // Cerrar resultados si se hace clic fuera
        document.addEventListener('click', function closeSearch(e) {
            if (!resultsContainer.contains(e.target) && e.target.id !== 'search-input') {
                resultsContainer.innerHTML = '';
                document.removeEventListener('click', closeSearch);
            }
        });
    }

    // ========================================================================
    // --- 5. NAVEGACIÓN ---
    // ========================================================================

    function setupNav() {
        alphabetNavDesktop.innerHTML = '';
        alphabetNavMobile.innerHTML = '';

        const alphabet = [...new Set(glossaryData.map(item => item.letter))].sort();

        alphabet.forEach(letter => {
            // Desktop
            const linkDesktop = document.createElement('a');
            linkDesktop.href = '#';
            linkDesktop.textContent = letter;
            linkDesktop.className = 'nav-link w-10 h-10 lg:w-12 lg:h-12 flex items-center justify-center rounded-xl font-bold text-purple-800 hover:bg-white/50 transition-all duration-200';
            linkDesktop.dataset.letter = letter;
            
            // Mobile
            const linkMobile = document.createElement('a');
            linkMobile.href = '#';
            linkMobile.textContent = letter;
            linkMobile.className = 'nav-link h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-lg font-bold text-purple-800 hover:bg-white/50 transition-all duration-200';
            linkMobile.dataset.letter = letter;

            const handleNavClick = (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.classList.remove('active', 'bg-purple-600', 'text-white');
                    l.classList.add('text-purple-800');
                });
                
                // Activar estilos
                const activeLinks = document.querySelectorAll(`.nav-link[data-letter="${letter}"]`);
                activeLinks.forEach(l => {
                    l.classList.add('active', 'bg-purple-600', 'text-white');
                    l.classList.remove('text-purple-800');
                });

                renderizarListaDeTerminos(letter);
            };

            linkDesktop.addEventListener('click', handleNavClick);
            linkMobile.addEventListener('click', handleNavClick);

            alphabetNavDesktop.appendChild(linkDesktop);
            alphabetNavMobile.appendChild(linkMobile);
        });
    }

    function handleHomeClick() {
        document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.remove('active', 'bg-purple-600', 'text-white');
            l.classList.add('text-purple-800');
        });
        mostrarAbrazoInicial();
    }

    // ========================================================================
    // --- 6. ANIMACIÓN (RIZOMA) ---
    // ========================================================================
    let nodes = [];
    let startTime = null;

    function resizeCanvas() {
        const container = document.getElementById('presentation-container');
        if(container && canvas) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
    }

    class Node {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 0.2;
            this.vy = (Math.random() - 0.5) * 0.2;
            this.radius = Math.random() * 1.5 + 0.5;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#9CA986';
            ctx.fill();
        }
    }

    function initRhizome() {
        nodes = [];
        for (let i = 0; i < 8; i++) nodes.push(new Node());
        startTime = Date.now();
    }

    function animate() {
        // Fondo con estela suave
        ctx.fillStyle = 'rgba(251, 249, 246, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Crecimiento progresivo de nodos
        const maxNodes = 40; 
        if (nodes.length < maxNodes && Math.random() < 0.02) {
            nodes.push(new Node());
        }

        // Dibujar conexiones
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                const dx = nodes[i].x - nodes[j].x;
                const dy = nodes[i].y - nodes[j].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                // Conectamos si están cerca
                if (dist < 150) {
                    ctx.beginPath();
                    ctx.moveTo(nodes[i].x, nodes[i].y);
                    ctx.lineTo(nodes[j].x, nodes[j].y);
                    // Línea más transparente cuanto más lejos
                    ctx.strokeStyle = `rgba(167, 139, 250, ${0.2 - dist/150})`;
                    ctx.stroke();
                }
            }
            nodes[i].update();
            nodes[i].draw();
        }
        requestAnimationFrame(animate);
    }
});
